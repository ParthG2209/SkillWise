name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  # ============================================================
  # PR Validation
  # ============================================================
  validate:
    name: Validate PR
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      # Type Check
      - name: TypeScript strict mode check
        id: typecheck
        run: |
          echo "## TypeScript Check" >> $GITHUB_STEP_SUMMARY
          if npm run typecheck 2>&1 | tee typecheck-output.txt; then
            echo "✅ No type errors found" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Type errors found:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat typecheck-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      
      # Lint Check
      - name: ESLint check
        id: lint
        run: |
          echo "## ESLint Check" >> $GITHUB_STEP_SUMMARY
          if npm run lint 2>&1 | tee lint-output.txt; then
            echo "✅ No linting errors found" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Linting errors found:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat lint-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      
      # Test with Coverage
      - name: Run tests with coverage
        id: test
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          npm run test:ci 2>&1 | tee test-output.txt
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          
          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "✅ All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Tests failed" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat test-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat coverage/coverage-summary.json | jq -r '.total | "Lines: \(.lines.pct)%\nStatements: \(.statements.pct)%\nBranches: \(.branches.pct)%\nFunctions: \(.functions.pct)%"' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          exit $TEST_EXIT_CODE
      
      # Coverage Threshold Check
      - name: Check coverage thresholds
        run: |
          LINES=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')
          FUNCTIONS=$(cat coverage/coverage-summary.json | jq -r '.total.functions.pct')
          BRANCHES=$(cat coverage/coverage-summary.json | jq -r '.total.branches.pct')
          STATEMENTS=$(cat coverage/coverage-summary.json | jq -r '.total.statements.pct')
          
          echo "## Coverage Threshold Check" >> $GITHUB_STEP_SUMMARY
          
          PASSED=true
          
          if (( $(echo "$LINES < 90" | bc -l) )); then
            echo "❌ Lines coverage ($LINES%) is below 90%" >> $GITHUB_STEP_SUMMARY
            PASSED=false
          else
            echo "✅ Lines: $LINES%" >> $GITHUB_STEP_SUMMARY
          fi
          
          if (( $(echo "$FUNCTIONS < 90" | bc -l) )); then
            echo "❌ Functions coverage ($FUNCTIONS%) is below 90%" >> $GITHUB_STEP_SUMMARY
            PASSED=false
          else
            echo "✅ Functions: $FUNCTIONS%" >> $GITHUB_STEP_SUMMARY
          fi
          
          if (( $(echo "$BRANCHES < 90" | bc -l) )); then
            echo "❌ Branches coverage ($BRANCHES%) is below 90%" >> $GITHUB_STEP_SUMMARY
            PASSED=false
          else
            echo "✅ Branches: $BRANCHES%" >> $GITHUB_STEP_SUMMARY
          fi
          
          if (( $(echo "$STATEMENTS < 90" | bc -l) )); then
            echo "❌ Statements coverage ($STATEMENTS%) is below 90%" >> $GITHUB_STEP_SUMMARY
            PASSED=false
          else
            echo "✅ Statements: $STATEMENTS%" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$PASSED" = false ]; then
            exit 1
          fi
      
      # Build Check
      - name: Build verification
        run: |
          echo "## Build Check" >> $GITHUB_STEP_SUMMARY
          if npm run build 2>&1 | tee build-output.txt; then
            echo "✅ Build successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Build failed:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat build-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # ============================================================
  # Size Check
  # ============================================================
  size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build and check size
        run: |
          npm run build
          
          echo "## Build Size Report" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          du -sh dist/ >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Individual files:" >> $GITHUB_STEP_SUMMARY
          find dist -name "*.js" -exec du -h {} \; >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # PR Comment with Results
  # ============================================================
  comment:
    name: Post Results Comment
    runs-on: ubuntu-latest
    needs: [validate, size-check]
    if: always() && github.event.pull_request.draft == false
    
    steps:
      - name: Create comment
        uses: actions/github-script@v7
        with:
          script: |
            const validateResult = '${{ needs.validate.result }}';
            const sizeResult = '${{ needs.size-check.result }}';
            
            let status = '✅ All checks passed!';
            let details = [];
            
            if (validateResult !== 'success') {
              status = '❌ Some checks failed';
              details.push('- ❌ Validation checks failed');
            } else {
              details.push('- ✅ TypeScript type check passed');
              details.push('- ✅ ESLint check passed');
              details.push('- ✅ Tests passed with >90% coverage');
              details.push('- ✅ Build successful');
            }
            
            if (sizeResult !== 'success') {
              details.push('- ⚠️ Size check had issues');
            } else {
              details.push('- ✅ Bundle size check passed');
            }
            
            const body = `## PR Check Results
            
${status}

### Details
${details.join('\n')}

---
_Generated by CI workflow_`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('## PR Check Results')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
